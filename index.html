<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Research Job Finder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }

        .search-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }


        button {
            width: 100%;
            padding: 14px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .status.loading {
            background: #e8f4f8;
            color: #2980b9;
        }

        .status.error {
            background: #fadbd8;
            color: #c0392b;
        }

        .status.success {
            background: #d5f4e6;
            color: #27ae60;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .clear-btn {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            width: auto;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .job-list {
            display: grid;
            gap: 16px;
        }

        .job-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s;
        }

        .job-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }

        .job-header-left {
            flex: 1;
        }

        .job-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
        }

        .job-company {
            font-size: 16px;
            color: #3498db;
        }

        .job-date {
            flex-shrink: 0;
            padding: 6px 12px;
            background: #3498db;
            color: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .job-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .job-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .job-link {
            display: inline-block;
            padding: 10px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .job-link:hover {
            background: #2980b9;
        }

        .job-source {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 8px;
            background: #ecf0f1;
            color: #7f8c8d;
            border-radius: 4px;
            font-size: 12px;
        }

        .job-description {
            margin: 12px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #555;
        }

        .job-description ul {
            margin: 8px 0 0 0;
            padding-left: 20px;
        }

        .job-description li {
            margin-bottom: 4px;
        }

        .job-requirements {
            margin-bottom: 16px;
            font-size: 13px;
            color: #666;
        }

        .job-requirements ul {
            margin: 6px 0 0 0;
            padding-left: 20px;
        }

        .job-requirements li {
            margin-bottom: 4px;
        }

        .job-requirements strong {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #555;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state p {
            font-size: 16px;
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }

            h1 {
                font-size: 24px;
            }

            .search-section {
                padding: 20px;
            }

            .job-card {
                padding: 16px;
            }

            .job-title {
                font-size: 16px;
            }

            .job-header {
                flex-direction: column;
                gap: 8px;
            }

            .job-date {
                align-self: flex-start;
            }

            .job-meta {
                flex-direction: column;
                gap: 6px;
            }

            .results-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>User Research Job Finder</h1>
            <p class="subtitle">Discover where to find remote user research positions across the web</p>
        </header>

        <div class="search-section">
            <button id="searchBtn" onclick="searchJobs()">Find Jobs</button>
            <div id="status"></div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const JOBS_STORAGE = 'cached_jobs';

        // Load results from localStorage on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedJobs = localStorage.getItem(JOBS_STORAGE);
            if (savedJobs) {
                const jobs = JSON.parse(savedJobs);
                displayResults(jobs);
            }
        });

        async function searchJobs() {
            const statusEl = document.getElementById('status');
            const searchBtn = document.getElementById('searchBtn');

            searchBtn.disabled = true;
            showStatus('Searching for jobs... This may take a minute.', 'loading');

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'sonar-pro',
                        messages: [{
                            role: 'user',
                            content: `Find the TOP 10 HIGHEST-QUALITY job boards and career sites that CURRENTLY have active remote user research job listings. Exclude LinkedIn. Quality over quantity - only include sources you can VERIFY have real listings right now.

VERIFICATION REQUIREMENTS (CRITICAL):
- You MUST verify each source has at least 5+ active remote UX/User Research postings before including it
- Check that the URL you provide actually returns search results (not an empty page)
- If you cannot confirm listings exist, DO NOT include that source
- NO DUPLICATES - each source should appear only once
- Return EXACTLY 10 sources maximum

Priority order (include ONLY if they have verified listings):
1. TIER 1 - Major high-traffic boards: Indeed, ZipRecruiter, Glassdoor, Monster, SimplyHired
2. TIER 2 - Remote-specific boards: We Work Remotely, RemoteOK, FlexJobs, Remote.co, Remotive
3. TIER 3 - Tech/UX specialist boards: AngelList/Wellfound, Built In, User Interviews Jobs, Cofolios
4. TIER 4 - Only if above tiers don't have 10 sources: Dribbble, Behance Jobs, Otta, Startup.jobs

For each source, provide:
- title: Descriptive title (e.g., "Remote UX Research Jobs on [Board Name]")
- company: The job board name (UNIQUE - no duplicates)
- location: "Remote"
- posted_date: 2026-01-21
- url: Direct link to FILTERED search results for "user research" OR "UX researcher" remote jobs
- source: "Job Board" or "Specialized Board"
- description: EXACT count of active listings you verified (e.g., "47 remote user research roles available as of today")
- requirements: Filter tips if needed (e.g., "Sort by date posted for newest listings")

Return ONLY valid JSON array - NO markdown, NO extra text:
[
  {
    "title": "Remote User Research Jobs",
    "company": "Indeed",
    "location": "Remote",
    "posted_date": "2026-01-21",
    "url": "https://www.indeed.com/jobs?q=user+research&l=Remote&sort=date",
    "source": "Job Board",
    "description": "120+ remote user research positions available as of today",
    "requirements": "Filter by 'Date Posted: Last 14 days' for freshest listings"
  }
]

CRITICAL: If a source returns 0 results or you cannot verify listings exist, skip it entirely. Better to return 5-8 high-quality sources than 10 sources where half are dead.`
                        }],
                        temperature: 0.2
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const content = data.choices[0].message.content;

                console.log('Raw API Response:', content);

                // Extract JSON from response (handle markdown code blocks and citations)
                let jsonText = content.trim();

                // Remove markdown code blocks if present
                jsonText = jsonText.replace(/```json\s*/g, '').replace(/```\s*/g, '');

                // Try to find JSON array - be more flexible
                let jsonMatch = jsonText.match(/\[\s*\{[\s\S]*\}\s*\]/);

                if (!jsonMatch) {
                    // Try alternative: maybe it's just the array
                    if (jsonText.startsWith('[') && jsonText.includes(']')) {
                        const lastBracket = jsonText.lastIndexOf(']');
                        jsonMatch = [jsonText.substring(0, lastBracket + 1)];
                    }
                }

                if (!jsonMatch) {
                    console.error('Could not find JSON array in response:', content);
                    throw new Error('Could not parse job results from API response. Check browser console for details.');
                }

                // Remove citation markers like [1], [2], etc. from the extracted JSON
                let cleanJson = jsonMatch[0].replace(/\[(\d+)\]/g, '');

                console.log('Cleaned JSON:', cleanJson);

                let jobs = JSON.parse(cleanJson);

                // Remove duplicates
                jobs = removeDuplicates(jobs);

                // Sort by date (newest first)
                jobs.sort((a, b) => new Date(b.posted_date) - new Date(a.posted_date));

                // Save to localStorage
                localStorage.setItem(JOBS_STORAGE, JSON.stringify(jobs));

                displayResults(jobs);
                showStatus(`Found ${jobs.length} job sources to explore`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                searchBtn.disabled = false;
            }
        }

        function removeDuplicates(jobs) {
            const seen = new Set();
            return jobs.filter(job => {
                // Deduplicate by company name only since we're showing sources, not individual jobs
                const key = job.company.toLowerCase().trim();
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }

        function formatAsBullets(text) {
            if (!text) return '';
            // Split by periods or line breaks, filter empty strings
            const sentences = text.split(/[.\n]/).map(s => s.trim()).filter(s => s.length > 0);
            if (sentences.length === 0) return '';
            return '<ul>' + sentences.map(s => `<li>${escapeHtml(s)}</li>`).join('') + '</ul>';
        }

        function displayResults(jobs) {
            const resultsEl = document.getElementById('results');

            if (!jobs || jobs.length === 0) {
                resultsEl.innerHTML = '<div class="empty-state"><p>No jobs found yet. Click "Find Jobs" to start searching.</p></div>';
                return;
            }

            // Always sort by date (newest first)
            jobs.sort((a, b) => new Date(b.posted_date) - new Date(a.posted_date));

            const html = `
                <div class="results-header">
                    <div class="results-count">${jobs.length} Job Sources Found</div>
                    <button class="clear-btn" onclick="clearResults()">Clear Results</button>
                </div>
                <div class="job-list">
                    ${jobs.map(job => `
                        <div class="job-card">
                            <div class="job-header">
                                <div class="job-header-left">
                                    <div class="job-title">${escapeHtml(job.title)}</div>
                                    <div class="job-company">${escapeHtml(job.company)}</div>
                                </div>
                                <div class="job-date">${formatDate(job.posted_date)}</div>
                            </div>
                            <div class="job-meta">
                                <span>üìç ${escapeHtml(job.location)}</span>
                            </div>
                            ${job.description ? `<div class="job-description">${formatAsBullets(job.description)}</div>` : ''}
                            ${job.requirements ? `<div class="job-requirements"><strong>Tips:</strong>${formatAsBullets(job.requirements)}</div>` : ''}
                            <a href="${escapeHtml(job.url)}" target="_blank" class="job-link">Browse Jobs</a>
                            <span class="job-source">${escapeHtml(job.source)}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            resultsEl.innerHTML = html;
        }

        function clearResults() {
            localStorage.removeItem(JOBS_STORAGE);
            document.getElementById('results').innerHTML = '<div class="empty-state"><p>Results cleared. Click "Find Jobs" to search again.</p></div>';
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
